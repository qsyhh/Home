<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no">
    <title>小雨音乐 - 网易云在线播放</title>
    <link rel="shortcut icon" href="images/icon/favicon.ico">
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://cdn.jsdelivr.net/npm/font-awesome@4.7.0/css/font-awesome.min.css" rel="stylesheet">
    <script>
        tailwind.config = {
            theme: {
                extend: {
                    colors: {
                        primary: '#6366f1',
                        secondary: '#8b5cf6',
                        dark: '#0f172a',
                        light: '#f8fafc',
                    },
                    fontFamily: {
                        inter: ['Inter','system-ui','sans-serif'],
                    },
                    boxShadow: {
                        'music': '0 4px 20px rgba(99, 102, 241, 0.15)',
                        'music-hover': '0 8px 30px rgba(99, 102, 241, 0.25)',
                    }
                }
            }
        }
    </script>
    <style type="text/tailwindcss">
        @layer utilities {
            .content-auto { content-visibility: auto; }
            .backdrop-blur-sm { backdrop-filter: blur(8px); -webkit-backdrop-filter: blur(8px); }
            .backdrop-blur-md { backdrop-filter: blur(12px); -webkit-backdrop-filter: blur(12px); }
            .text-shadow { text-shadow: 0 2px 8px rgba(0,0,0,0.3); }
            .scrollbar-hide::-webkit-scrollbar { display: none; }
            .scrollbar-hide { -ms-overflow-style: none; scrollbar-width: none; }
            .img-cover { object-fit: cover !important; object-position: center; }
            .music-card { transition: all 0.4s cubic-bezier(0.25, 0.8, 0.25, 1); }
            .music-card:hover { transform: translateY(-6px) scale(1.02); box-shadow: var(--tw-shadow-music-hover); }
            .btn-hover { transition: all 0.3s cubic-bezier(0.25, 1, 0.5, 1); }
            .btn-hover:hover { transform: scale(1.08); }
            .lyric-line { position: relative; padding: 6px 10px; color: #94a3b8; transition: all 0.3s ease; white-space: nowrap; }
            .lyric-active { color: white !important; font-weight: 500 !important; transform: scale(1.05); }
            .lyric-active .lyric-text { background: linear-gradient(to right, #3b82f6 0%, #60a5fa 100%); -webkit-background-clip: text; -webkit-text-fill-color: transparent; background-clip: text; position: relative; }
            .lyric-highlight-bg { position: absolute; left: 0; top: 0; height: 100%; background: #3b82f6; opacity: 0.25; border-radius: 4px; z-index: -1; transition: width 0.05s linear; }
            .toast-notification { transition: all 0.3s ease; }
            .progress-container { height: 8px !important; min-height: 8px !important; }
            .progress-bar { height: 100% !important; }
            .progress-handle { width: 14px !important; height: 14px !important; opacity: 1 !important; transition: all 0.2s ease !important; }
            .progress-container:hover .progress-handle { transform: translate(-50%, -50%) scale(1.2) !important; }
            .fade-in { animation: fadeIn 0.6s ease forwards; }
            @keyframes fadeIn { from { opacity: 0; transform: translateY(10px); } to { opacity: 1; transform: translateY(0); } }
        }
    </style>
</head>
<body class="bg-cover bg-center bg-fixed bg-no-repeat text-light min-h-screen font-inter antialiased" style="background-image: url('https://tu.ltyuanfang.cn/api/fengjing.php')">
<header class="fixed top-0 left-0 right-0 z-50 bg-dark/80 backdrop-blur-md border-b border-slate-800/50">
    <div class="container mx-auto px-4 py-3 flex items-center justify-between">
        <div class="flex items-center gap-2">
            <i class="fa fa-music text-primary text-2xl"></i>
            <h1 class="text-xl md:text-2xl font-bold bg-gradient-to-r from-primary to-secondary bg-clip-text text-transparent">小雨音乐</h1>
        </div>
        <div class="flex-1 max-w-xl mx-3 md:mx-4 relative">
            <input type="text" id="search-input" placeholder="搜索网易云歌曲、歌手..." class="w-full bg-slate-800/80 border border-slate-700/50 rounded-full py-2 px-4 pl-10 pr-10 focus:outline-none focus:ring-2 focus:ring-primary/50 transition-all text-sm md:text-base">
            <i class="fa fa-search absolute left-4 top-1/2 translate-y-[-50%] text-slate-40"></i>
            <button id="mobile-search-btn" class="absolute right-3 top-1/2 translate-y-[-50%] bg-primary text-white p-1.5 rounded-full md:hidden w-8 h-8 flex items-center justify-center">
                <i class="fa fa-search text-sm"></i>
            </button>
            <div id="search-dropdown" class="absolute top-full left-0 right-0 mt-2 bg-slate-900/95 backdrop-blur-md rounded-lg border border-slate-700 shadow-xl z-50 max-h-60 overflow-y-auto scrollbar-hide hidden"></div>
        </div>
        <button id="theme-toggle" class="p-2 md:p-3 rounded-full hover:bg-slate-800/50 transition-colors btn-hover">
            <i class="fa fa-moon-o text-slate-300"></i>
        </button>
    </div>
</header>

<main class="container mx-auto px-4 pt-20 md:pt-24 pb-32">
    <div id="search-results" class="mt-6 grid grid-cols-2 lg:grid-cols-5 gap-2 md:gap-3">
        <div id="initial-state" class="col-span-full flex flex-col items-center justify-center py-24 fade-in">
            <div class="w-32 h-32 mb-6 rounded-full overflow-hidden shadow-lg">
                <img src="https://tu.ltyuanfang.cn/api/fengjing.php" alt="音乐" class="w-full h-full img-cover">
            </div>
            <h3 class="text-2xl font-bold text-slate-200 mb-2">小雨音乐</h3>
            <p class="text-slate-400 text-center max-w-md">输入关键词搜索网易云音乐，支持在线播放与下载</p>
            <p class="mt-4 text-sm text-sm text-slate-500">仅用于内部学习交流,请勿商用</p>
        </div>
        <div id="loading-indicator" class="col-span-full hidden flex-col items-center justify-center py-20">
            <div class="animate-spin rounded-full h-14 w-14 border-t-3 border-b-3 border-primary mb-4"></div>
            <p class="text-slate-400">正在搜索音乐...</p>
        </div>
        <div id="empty-state" class="hidden col-span-full flex flex-col items-center justify-center py-20">
            <div class="w-24 h-24 mb-4 bg-slate-800/50 rounded-full flex items-center justify-center">
                <i class="fa fa-headphones text-5xl text-slate-600"></i>
            </div>
            <h3 class="text-xl font-medium text-slate-300 mb-2">暂无搜索结果</h3>
            <p class="text-sm text-slate-500">尝试更换关键词试试</p>
        </div>
    </div>
</main>

<footer class="fixed bottom-0 left-0 right-0 bg-dark/90 backdrop-blur-md border-t border-slate-800/50 py-2 px-3 md:py-3 md:px-4">
    <div class="container mx-auto flex flex-col md:flex-row items-center gap-3 md:gap-4">
        <div class="flex items-center gap-2 flex-1 min-w-0">
            <div id="now-playing-cover" class="w-12 h-12 md:w-14 md:h-14 rounded-md overflow-hidden shadow-music">
                <img src="https://tu.ltyuanfang.cn/api/fengjing.php" alt="封面" class="w-full h-full img-cover">
            </div>
            <div class="min-w-0 flex flex-col">
                <h3 id="now-playing-title" class="font-medium text-sm md:text-base leading-tight">未播放音乐</h3>
                <p id="now-playing-artist" class="text-xs md:text-sm text-slate-400 leading-tight mt-1">点击歌曲开始播放</p>
            </div>
        </div>
        <div class="flex flex-col items-center gap-2 w-full md:w-auto">
            <div class="w-full flex items-center gap-2">
                <span id="current-time" class="text-xs text-slate-400 w-8 text-right">00:00</span>
                <div class="h-1 bg-slate-700/50 rounded-full flex-1 relative group cursor-pointer progress-container">
                    <div id="progress-bar" class="h-full bg-gradient-to-r from-primary to-secondary rounded-full w-0 relative progress-bar">
                        <div class="absolute right-0 top-1/2 translate-y-[-50%] w-3 h-3 bg-white rounded-full shadow-md opacity-100 progress-handle"></div>
                    </div>
                </div>
                <span id="total-time" class="text-xs text-slate-400 w-8">00:00</span>
            </div>
            <div class="flex items-center gap-5 md:gap-6">
                <button class="text-slate-300 hover:text-primary transition-colors btn-hover" id="prev-btn">
                    <i class="fa fa-step-backward text-base md:text-lg"></i>
                </button>
                <button class="text-slate-300 hover:text-primary transition-colors btn-hover bg-primary/10 rounded-full w-10 h-10 flex items-center justify-center" id="play-pause-btn">
                    <i class="fa fa-play text-lg md:text-xl" id="play-pause-icon"></i>
                </button>
                <button class="text-slate-300 hover:text-primary transition-colors btn-hover" id="next-btn">
                    <i class="fa fa-step-forward text-base md:text-lg"></i>
                </button>
            </div>
        </div>
        <div class="flex items-center gap-3 md:gap-4 flex-1 justify-end">
            <button id="lyrics-toggle" class="text-slate-300 hover:text-primary transition-colors btn-hover p-1 md:p-2">
                <i class="fa fa-comment-o text-base md:text-lg"></i>
            </button>
            <button id="volume-btn" class="text-slate-300 hover:text-primary transition-colors btn-hover p-1 md:p-2">
                <i class="fa fa-volume-up text-base md:text-lg" id="volume-icon"></i>
            </button>
            <input type="range" id="volume-slider" min="0" max="100" value="80" class="w-16 md:w-20 accent-primary hidden md:block">
        </div>
    </div>
</footer>

<div id="lyrics-modal" class="fixed inset-0 bg-dark/98 z-50 hidden flex items-center justify-center p-4">
    <div class="w-full max-w-md md:max-w-2xl h-[80vh] md:h-[70vh] bg-slate-900/95 rounded-xl overflow-hidden flex flex-col border border-slate-800 shadow-xl">
        <div class="p-4 border-b border-slate-800 flex justify-between items-center bg-slate-800/50">
            <h3 class="font-medium text-lg">歌词</h3>
            <button id="close-lyrics" class="text-slate-40 hover:text-white btn-hover p-2 rounded-full hover:bg-slate-700/50">
                <i class="fa fa-times"></i>
            </button>
        </div>
        <div id="lyrics-content" class="flex-1 overflow-y-auto p-4 md:p-6 text-center text-base md:text-lg leading-relaxed scrollbar-hide pt-8 pb-8">
            <p class="text-slate-500 flex items-center justify-center gap-2">
                <i class="fa fa-music"></i>暂无歌词</p>
        </div>
    </div>
</div>

<audio id="audio-player" preload="metadata">

<script>
const API_BASE_URL = 'https://metingapi.nanorocky.top/';
let currentMusicList = [];
let currentMusicIndex = -1;
let isPlaying = false;
let isMuted = false;
let audioPlayer = document.getElementById('audio-player');
let lyricsVisible = false;
let lyricLines = [];
let lyricTimeTags = [];
let retryCount = 0;
const MAX_RETRY = 3;
let isDragging = false;

const searchInput = document.getElementById('search-input');
const searchResults = document.getElementById('search-results');
const loadingIndicator = document.getElementById('loading-indicator');
const emptyState = document.getElementById('empty-state');
const initialState = document.getElementById('initial-state');
const playPauseIcon = document.getElementById('play-pause-icon');
const playPauseBtn = document.getElementById('play-pause-btn');
const prevBtn = document.getElementById('prev-btn');
const nextBtn = document.getElementById('next-btn');
const nowPlayingCover = document.getElementById('now-playing-cover').querySelector('img');
const nowPlayingTitle = document.getElementById('now-playing-title');
const nowPlayingArtist = document.getElementById('now-playing-artist');
const progressBar = document.getElementById('progress-bar');
const currentTimeEl = document.getElementById('current-time');
const totalTimeEl = document.getElementById('total-time');
const volumeBtn = document.getElementById('volume-btn');
const volumeIcon = document.getElementById('volume-icon');
const volumeSlider = document.getElementById('volume-slider');
const lyricsToggle = document.getElementById('lyrics-toggle');
const lyricsModal = document.getElementById('lyrics-modal');
const closeLyrics = document.getElementById('close-lyrics');
const lyricsContent = document.getElementById('lyrics-content');
const progressContainer = progressBar.parentElement;
const mobileSearchBtn = document.getElementById('mobile-search-btn');
const themeToggle = document.getElementById('theme-toggle');
const searchDropdown = document.getElementById('search-dropdown');
const HISTORY_KEY = 'music_search_history';

function getHistory() {
    try { return JSON.parse(localStorage.getItem(HISTORY_KEY)) || []; } catch (e) { return []; }
}

function saveHistory(keyword) {
    if (!keyword.trim()) return;
    let list = getHistory();
    list = list.filter(k => k !== keyword);
    list.unshift(keyword);
    if (list.length > 8) list = list.slice(0, 8);
    localStorage.setItem(HISTORY_KEY, JSON.stringify(list));
}

function showDropdown() {
    const list = getHistory();
    searchDropdown.innerHTML = '';
    if (list.length === 0) { searchDropdown.classList.add('hidden'); return; }
    list.forEach(k => {
        const item = document.createElement('div');
        item.className = 'px-4 py-2 hover:bg-slate-800 cursor-pointer text-sm';
        item.textContent = k;
        item.onclick = () => {
            searchInput.value = k;
            searchDropdown.classList.add('hidden');
            searchMusic(k);
        };
        searchDropdown.appendChild(item);
    });
    searchDropdown.classList.remove('hidden');
}

function hideDropdown() {
    setTimeout(() => searchDropdown.classList.add('hidden'), 100);
}

function downloadMusic(url, name) {
    fetch(url)
        .then(res => res.blob())
        .then(blob => {
            const a = document.createElement('a');
            a.href = URL.createObjectURL(blob);
            a.download = name + '.mp3';
            a.style.display = 'none';
            document.body.appendChild(a);
            a.click();
            document.body.removeChild(a);
            setTimeout(() => URL.revokeObjectURL(a.href), 3000);
            showToast('开始下载：' + name);
        })
        .catch(() => showToast('下载失败'));
}

document.addEventListener('DOMContentLoaded', () => {
    loadingIndicator.classList.add('hidden');
    emptyState.classList.add('hidden');

    searchInput.addEventListener('focus', showDropdown);
    searchInput.addEventListener('blur', hideDropdown);
    
    searchInput.addEventListener('keypress', (e) => {
        const kw = searchInput.value.trim();
        if (e.key === 'Enter' && kw) {
            saveHistory(kw);
            searchDropdown.classList.add('hidden');
            searchMusic(kw);
        }
    });

    mobileSearchBtn.addEventListener('click', () => {
        const kw = searchInput.value.trim();
        if (kw) {
            saveHistory(kw);
            searchDropdown.classList.add('hidden');
            searchMusic(kw);
        }
    });

    playPauseBtn.addEventListener('click', togglePlayPause);
    prevBtn.addEventListener('click', playPrevious);
    nextBtn.addEventListener('click', playNext);
    audioPlayer.addEventListener('timeupdate', updateProgress);
    audioPlayer.addEventListener('loadedmetadata', updateTotalTime);
    audioPlayer.addEventListener('ended', playNext);
    audioPlayer.addEventListener('error', handleAudioError);
    progressContainer.addEventListener('mousedown', () => isDragging = true);
    document.addEventListener('mouseup', () => isDragging = false);
    progressContainer.addEventListener('mousemove', (e) => isDragging && seekAudio(e));
    progressContainer.addEventListener('click', seekAudio);
    progressContainer.addEventListener('touchmove', (e) => { e.preventDefault(); seekAudio(e.touches[0]); });
    volumeSlider.addEventListener('input', adjustVolume);
    volumeBtn.addEventListener('click', toggleMute);
    lyricsToggle.addEventListener('click', toggleLyrics);
    closeLyrics.addEventListener('click', toggleLyrics);
    themeToggle.addEventListener('click', toggleTheme);
    audioPlayer.volume = volumeSlider.value / 100;

    searchMusic('热门歌曲');
});

document.addEventListener('keydown', (e) => {
    if (!audioPlayer.duration) return;
    if (e.key === 'ArrowLeft') { audioPlayer.currentTime = Math.max(0, audioPlayer.currentTime - 10); updateProgress(); }
    if (e.key === 'ArrowRight') { audioPlayer.currentTime = Math.min(audioPlayer.duration, audioPlayer.currentTime + 10); updateProgress(); }
});

function handleAudioError() {
    if (retryCount < MAX_RETRY) {
        retryCount++;
        showToast('播放失败，正在重试 ' + retryCount + '/' + MAX_RETRY);
        setTimeout(() => { if (currentMusicIndex !== -1) playMusic(currentMusicIndex); }, 200);
    } else {
        showToast('重试失败，该歌曲无法播放');
        isPlaying = false;
        updatePlayPauseIcon();
        retryCount = 0;
        if (currentMusicList.length > 1) playNext();
    }
}

async function searchMusic(keyword) {
    initialState.classList.add('hidden');
    emptyState.classList.add('hidden');
    loadingIndicator.classList.remove('hidden');
    searchResults.innerHTML = '';
    try {
        const url = `${API_BASE_URL}?server=netease&type=search&id=0&dwrc=true&keyword=${encodeURIComponent(keyword)}`;
        const controller = new AbortController();
        const timeoutId = setTimeout(() => controller.abort(), 10000);
        const response = await fetch(url, { signal: controller.signal, headers: { 'Accept': 'application/json' } });
        clearTimeout(timeoutId);
        if (!response.ok) throw new Error();
        const musicList = await response.json();
        currentMusicList = Array.isArray(musicList) ? musicList : [];
        loadingIndicator.classList.add('hidden');
        if (currentMusicList.length === 0) { emptyState.classList.remove('hidden'); return; }
        renderMusicList(currentMusicList);
        showToast('搜索完成，自动播放中');
        setTimeout(() => playMusic(0), 500);
    } catch (error) {
        loadingIndicator.classList.add('hidden');
        emptyState.classList.remove('hidden');
        emptyState.querySelector('p').textContent = '搜索失败，请稍后重试';
    }
}

function renderMusicList(musicList) {
    musicList.forEach((music, index) => {
        const duration = formatTime(music.duration || 0);
        const musicCard = document.createElement('div');
        musicCard.className = 'bg-slate-800/70 rounded-lg overflow-hidden shadow-music music-card border border-slate-700/50 fade-in';
        const coverUrl = music.pic || '';
        musicCard.innerHTML = `
            <div class="relative w-full aspect-square">
                <img src="${coverUrl}" alt="${music.name}" class="w-full h-full img-cover" loading="lazy">
                <div class="absolute inset-0 bg-gradient-to-t from-black/90 via-black/40 to-transparent flex items-end p-2">
                    <div class="w-full">
                        <h3 class="font-medium text-shadow truncate text-white text-xs">${music.name || '未知歌曲'}</h3>
                        <p class="text-[10px] text-slate-200 truncate mt-0.5">${music.artist || '未知歌手'}</p>
                        <div class="flex justify-between items-center mt-1 gap-1">
                            <span class="text-[9px] text-slate-300 bg-black/30 px-1 py-0.5 rounded-full">${duration}</span>
                            <div class="flex gap-1">
                                <button class="download-btn p-1 bg-green-600/90 rounded-full hover:bg-green-600 transition-colors btn-hover" data-index="${index}">
                                    <i class="fa fa-download text-[10px] text-white"></i>
                                </button>
                                <button class="play-btn p-1 bg-primary/90 rounded-full hover:bg-primary transition-colors btn-hover" data-index="${index}">
                                    <i class="fa fa-play text-[10px] text-white"></i>
                                </button>
                            </div>
                        </div>
                    </div>
                </div>
            </div>`;
        searchResults.appendChild(musicCard);
        
        musicCard.querySelector('.play-btn').addEventListener('click', () => playMusic(index));
        musicCard.querySelector('.download-btn').addEventListener('click', () => downloadMusic(music.url, music.name + ' - ' + music.artist));
        musicCard.addEventListener('dblclick', () => downloadMusic(music.url, music.name + ' - ' + music.artist));
    });
}

async function getRealAudioUrl(redirectUrl) {
    try {
        const response = await fetch(redirectUrl, { method: 'HEAD', redirect: 'follow', headers: { 'User-Agent': 'Mozilla/5.0 (Windows NT 10.0; Win64; x64) AppleWebKit/537.36 (KHTML, like Gecko) Chrome/120.0.0.0 Safari/537.36' } });
        return response.url || redirectUrl;
    } catch (error) {
        return redirectUrl;
    }
}

async function playMusic(index) {
    if (index < 0 || index >= currentMusicList.length) return;
    const music = currentMusicList[index];
    currentMusicIndex = index;
    retryCount = 0;
    nowPlayingCover.src = music.pic || '';
    nowPlayingTitle.textContent = music.name || '未知歌曲';
    nowPlayingArtist.textContent = music.artist || '未知歌手';
    try {
        const realAudioUrl = await getRealAudioUrl(music.url);
        audioPlayer.src = realAudioUrl;
        audioPlayer.load();
        await audioPlayer.play();
        isPlaying = true;
        updatePlayPauseIcon();
        loadLyrics(music);
    } catch (err) {
        handleAudioError();
    }
}

async function loadLyrics(music) {
    try {
        if (!music.lrc || !music.lrc.includes('id=')) {
            lyricsContent.innerHTML = '<p class="text-slate-500"><i class="fa fa-music"></i> 暂无歌词</p>';
            lyricLines = [];
            lyricTimeTags = [];
            return;
        }
        const songId = music.lrc.split('id=')[1].split('&')[0];
        const url = `${API_BASE_URL}?server=netease&type=lrc&id=${songId}&dwrc=true`;
        const response = await fetch(url);
        const lyrics = await response.text();
        parseAndRenderLyrics(lyrics);
    } catch (error) {
        lyricsContent.innerHTML = '<p class="text-slate-500"><i class="fa fa-music"></i> 暂无歌词</p>';
    }
}

function parseAndRenderLyrics(lyricsText) {
    lyricLines = [];
    lyricTimeTags = [];
    const lrcLines = lyricsText.split('\n');
    const lyricsHTML = [];
    lrcLines.forEach(line => {
        const timeMatch = line.match(/\[(\d{2}):(\d{2})(?:\.(\d{2}))?\]/);
        if (timeMatch) {
            const minutes = parseInt(timeMatch[1]);
            const seconds = parseInt(timeMatch[2]);
            const ms = timeMatch[3] ? parseInt(timeMatch[3]) * 10 : 0;
            const time = minutes * 60 + seconds + ms / 1000;
            const text = line.replace(/\[.*?\]/g, '').trim();
            if (text) {
                lyricTimeTags.push(time);
                lyricLines.push(text);
                lyricsHTML.push(`<p class="lyric-line"><span class="lyric-highlight-bg"></span><span class="lyric-text">${text}</span></p>`);
            }
        }
    });
    lyricsContent.innerHTML = lyricsHTML.join('') || '<p class="text-slate-500">暂无歌词</p>';
}

function togglePlayPause() {
    if (currentMusicIndex === -1 && currentMusicList.length > 0) { playMusic(0); return; }
    if (isPlaying) { audioPlayer.pause(); } else { audioPlayer.play().catch(() => showToast('播放失败')); }
    isPlaying = !isPlaying;
    updatePlayPauseIcon();
}

function updatePlayPauseIcon() {
    playPauseIcon.className = isPlaying ? 'fa fa-pause text-lg md:text-xl' : 'fa fa-play text-lg md:text-xl';
}

function playPrevious() {
    if (currentMusicList.length === 0) return;
    const newIdx = currentMusicIndex <= 0 ? currentMusicList.length - 1 : currentMusicIndex - 1;
    playMusic(newIdx);
}

function playNext() {
    if (currentMusicList.length === 0) return;
    const newIdx = currentMusicIndex >= currentMusicList.length - 1 ? 0 : currentMusicIndex + 1;
    playMusic(newIdx);
}

function updateProgress() {
    if (isNaN(audioPlayer.duration)) return;
    const percent = (audioPlayer.currentTime / audioPlayer.duration) * 100;
    progressBar.style.width = `${percent}%`;
    currentTimeEl.textContent = formatTime(audioPlayer.currentTime * 1000);
    highlightCurrentLyric();
}

function updateTotalTime() {
    totalTimeEl.textContent = formatTime(audioPlayer.duration * 1000);
}

function seekAudio(e) {
    const rect = progressContainer.getBoundingRect();
    const x = e.clientX - rect.left;
    const percent = Math.max(0, Math.min(1, x / rect.width));
    audioPlayer.currentTime = percent * audioPlayer.duration;
    updateProgress();
}

function adjustVolume() {
    audioPlayer.volume = volumeSlider.value / 100;
    isMuted = audioPlayer.volume === 0;
    updateVolumeIcon();
}

function toggleMute() {
    audioPlayer.muted = !audioPlayer.muted;
    isMuted = audioPlayer.muted;
    volumeSlider.value = audioPlayer.muted ? 0 : 80;
    audioPlayer.volume = audioPlayer.muted ? 0 : 0.8;
    updateVolumeIcon();
}

function updateVolumeIcon() {
    if (audioPlayer.muted || audioPlayer.volume === 0) {
        volumeIcon.className = 'fa fa-volume-off text-base md:text-lg';
    } else if (audioPlayer.volume < 0.5) {
        volumeIcon.className = 'fa fa-volume-down text-base md:text-lg';
    } else {
        volumeIcon.className = 'fa fa-volume-up text-base md:text-lg';
    }
}

function toggleLyrics() {
    lyricsVisible = !lyricsVisible;
    lyricsModal.classList.toggle('hidden', !lyricsVisible);
    document.body.style.overflow = lyricsVisible ? 'hidden' : 'auto';
}

function highlightCurrentLyric() {
    if (!lyricsVisible || lyricTimeTags.length === 0) return;
    const lines = document.querySelectorAll('.lyric-line');
    const curr = audioPlayer.currentTime;
    let idx = -1;
    for (let i = 0; i < lyricTimeTags.length; i++) {
        if (curr >= lyricTimeTags[i]) idx = i;
        else break;
    }
    lines.forEach((l, i) => {
        const bg = l.querySelector('.lyric-highlight-bg');
        if (i === idx && idx !== -1) {
            l.classList.add('lyric-active');
            let progress = 1;
            if (i < lyricTimeTags.length - 1) {
                const total = lyricTimeTags[i + 1] - lyricTimeTags[i];
                const elapsed = curr - lyricTimeTags[i];
                progress = Math.min(1, elapsed / total);
            }
            bg.style.width = `${progress * 100}%`;
        } else {
            l.classList.remove('lyric-active');
            bg.style.width = '0%';
        }
    });
    if (idx >= 0 && lines[idx]) {
        lines[idx].scrollIntoView({ behavior: 'smooth', block: 'center' });
    }
}

function toggleTheme() {
    const body = document.body;
    body.classList.toggle('from-dark');
    body.classList.toggle('to-slate-900');
    body.classList.toggle('bg-white');
    body.classList.toggle('text-dark');
    const icon = themeToggle.querySelector('i');
    icon.classList.toggle('fa-moon-o');
    icon.classList.toggle('fa-sun-o');
    icon.classList.toggle('text-slate-300');
    icon.classList.toggle('text-slate-700');
}

function formatTime(ms) {
    if (isNaN(ms)) return '00:00';
    const s = Math.floor(ms / 1000);
    const m = Math.floor(s / 60);
    const sec = s % 60;
    return `${String(m).padStart(2, '0')}:${String(sec).padStart(2, '0')}`;
}

function showToast(message) {
    const old = document.querySelector('.toast-notification');
    if (old) old.remove();
    const t = document.createElement('div');
    t.className = 'toast-notification fixed bottom-20 left-1/2 translate-x-[-50%] bg-slate-800/95 text-white px-4 py-2 rounded-lg shadow-lg z-50 backdrop-blur-sm border border-slate-700';
    t.textContent = message;
    document.body.appendChild(t);
    setTimeout(() => { t.style.opacity = 0; setTimeout(() => t.remove(), 500); }, 2000);
}
</script>
</body>
</html>

